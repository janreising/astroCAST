\subsection{Installing \ac{astroCAST}}

\todo{Jan}{There was something about where to put tables!?}{}

\begin{table}[h!]
    \centering
    \caption{Availability of different functionalities of astroCAST across
    operating systems. A check mark (\cmark) denotes full compatibility and active support. An asterisk (\optional)
        indicates that the
    functionality is optional and can be installed upon user request (see below). A cross mark (\xmark) signifies
        that the
    functionality is not supported or available on the operating system. A half bullet (\halfbullet) indicates
        partial support,
    indicating that the functionality is expected to be available but is not actively tested.  }
    \label{tab:functionalities}
    \begin{tabular}{|l|c|c|c|c|}
        \hline
        \textbf{Functionality} & \textbf{Linux} & \textbf{Windows} & \textbf{MacOS (Intel)} & \textbf{Docker} \\ \hline
        Preprocessing          & \cmark         & \cmark           & \cmark                 & \cmark          \\ \hline
        Motion correction      & \cmark         & \cmark           & \cmark                 & \cmark          \\ \hline
        Denoising              & \cmark         & \halfbullet      & \cmark                 & \cmark          \\ \hline
        Delta                  & \cmark         & \cmark           & \cmark                 & \cmark          \\ \hline
        Detection              & \cmark         & \cmark           & \cmark                 & \cmark          \\ \hline
        UMAP outlier detection & \cmark         & \cmark           & \xmark                 & \cmark          \\ \hline
        Encoding - all         & \cmark         & \cmark           & \cmark                 & \cmark          \\ \hline
        Analysis               &                &                  &                        &                 \\ \hline
        DTW distance           & \cmark         & \cmark           & \xmark                 & \cmark          \\ \hline
        Barycenters            & \cmark         & \cmark           & \xmark                 & \cmark          \\ \hline
        Video player \optional & \cmark         & \cmark           & \cmark                 & \xmark          \\ \hline
    \end{tabular}
\end{table}

To run the software, you need to install the astroCAST package and its dependencies. There are multiple options to install \ac{astroCAST} depending on how much control users would like to have over the installation. Of note, the following instructions install astroCAST with its full functionality. If that is not desired or possible remove the \inlineBash{-E all} or \inlineBash{[all]} flags.

\subsubsection{Create conda environment}
While not strictly necessary, we highly recommend to create a fresh anaconda environment for the installation. This
prevents common installation errors and conflicts with existing environments.

\begin{lstlisting}[style=bashStyle]
    $ conda create -n astro python=3.9 poetry
    $ conda activate astro
\end{lstlisting}

\subsubsection{Install from source (recommended)}
\label{res:install-from-source}
\begin{lstlisting}[style=bashStyle]
    $ cd "/path/to/directory/"
    $ git clone git@github.com:janreising/astroCAST.git
    $ cd astroCAST
    $ poetry install -E all
\end{lstlisting}

\subsubsection{Installation with pip (easiest)}
\begin{lstlisting}[style=bashStyle]
    $ pip install astrocast[all]
\end{lstlisting}

\subsubsection{Container installation (last resort)}

To install docker and create an account, follow the instructions on the docker webpage: https://docs.docker
.com/engine/install/

\begin{lstlisting}[style=bashStyle]
    $ docker pull anacgon/astrocast:latest
    $ docker image ls
    $ docker run -v /path/to/your/data:/home/data -it -p 8888:8888 astrocast:latest
    # Optionally, start jupyter notebook from inside the docker container:
    $ jupyter-lab --allow-root --no-browser --port=8888 --ip="*"
\end{lstlisting}

\subsubsection{Test installation}

Both commands should run without any errors.

\begin{lstlisting}[style=bashStyle]
    $ python -c "import astrocast"
    $ astrocast --help
\end{lstlisting}

\subsection{Running astroCAST}

There are several ways to analyze data using \ac{astroCAST}, which we will reference throughout the protocol.

\subsubsection{Using jupyter notebooks}

Jupyter notebooks can be used to interactively run the analysis and visualize the results.
If you have cloned the repository (\ref{res:install-from-source}), an example notebook is included with the necessary
code to perform a basic analysis.

\begin{lstlisting}[style=bashStyle]
    $ cd "/path/to/astroCAST/notebooks/examples/"
    $ jupyter lab
    # on MacOS the command might be
    $ jupyter-notebook
\end{lstlisting}

A browser window will open which displays the available examples or can be used to create custom notebooks.

\subsubsection{Using the \ac{CLI}}

The \ac{CLI} is a useful selection of commands that enables users to perform common analysis steps directly from the terminal. Especially in the context of cluster or slurm environment this way of interacting with astroCAST is convenient. All parameters can either be provided manually in the terminal or through a configuration YAML file. We recommend using a configuration when preprocessing many video files to ensure continuity between settings.

\begin{lstlisting}[style=bashStyle]
    # get list of all available commands
    $ astrocast --help
    # get help for individual commands
    $ astrocast COMMAND --help
    # use manual settings
    $ astrocast COMMAND --PARAM-1 VALUE1 [...]
    # use a configuration file
    $ astrocast --config '/path/to/config' COMMAND [...]
\end{lstlisting}

The configuration file has to adhere to the YAML format and can contain settings for multiple commands. A default configuration file can be found in the \href{https://github.com/janreising/astroCAST/blob/3ad41d03068732419df7fdde9b2a0f449898d4e2/config.yaml}{GitHub repository}.

\begin{lstlisting}[style=yaml]
    COMMAND-NAME:
      PARAMETER_1: VALUE1
      PARAMETER_2: VALUE2

    COMMAND-NAME-2:
      PARAMETER_3: VALUE3
\end{lstlisting}

\subsubsection{Using the \ac{GUI}}

AstroCAST implements two \ac{GUI}s to simplify the selection of suitable parameters for the analysis. The commands below will either automatically open a browser page to the interface or provide a link that can be copied to a browser.

\begin{lstlisting}[style=bashStyle]
    # Identify correct settings for the event detection
    $ astrocast explorer -- input path /path/to/file -- h5-loc /dataset/name
    # Explore detected events, including filtering, embedding and experiments
    $ astrocast exploratory-analysis -- input path /path/to/roi/ -- h5-loc /dataset/name
\end{lstlisting}

\subsection{Data showcase}

In this protocol, we demonstrate the utility of our toolkit using publicly available datasets and our own data. The data represents astrocytes studied ex-vivo, in-vivo and in acute slices captured with \ac{1P} or \ac{2P} imaging at recording speeds of 1-16Hz.

To ensure transparency and provide a practical starting point, we offer a collection of sensible, default settings within a YAML file. This file, designed to represent a first-approach configuration, is accessible in our GitHub repository. Additionally, we provide the datasets used in this manuscript, as well as pretrained models. This repository serves as a comprehensive resource, aiding users in understanding and implementing the protocol with similar data characteristics.

\begin{lstlisting}[style=bashStyle]
    $ astrocast download-datasets "/path/to/download/directory"
    $ astrocast download-models "/path/to/download/directory"
\end{lstlisting}

\begin{table}[ht]
    \centering
    \caption{Overview of Datasets Employed in Analysis}
    \begin{tabular}{|l|l|l|l|l|l|}
        \hline
        \textbf{Dataset} & \textbf{Publication} & \textbf{Experiment} & \textbf{Imaging} \\ \hline
        train/test & previously unpublished & acute slices, Gcamp6f & \ac{1P} (8 Hz) \\ \hline
        ExVivo & AQuA\citep{wang_event-based_2018} & acute slices, Gcamp6f & \ac{2P} (1.1 Hz) \\ \hline
        Glusnfr & AQuA\citep{wang_event-based_2018} & acute slices, GluSnFR & \ac{2P} (4-100 Hz) \\ \hline
        InVivo & AQuA\citep{wang_event-based_2018} & in vivo GCamp6f & \ac{2P} (2 Hz) \\ \hline
        cellscan\_scim & CHIPS\citep{barrett_chips_2018} & blood vessels & \ac{2P} \\ \hline
    \end{tabular}
\end{table}

\subsection{Pipeline approach}
The AstroCAST pipeline is structured into three major blocks: a) Preprocessing, b) Encoding and c) Exploratory Analysis.

In the Preprocessing block (a), users can navigate the pipeline through a \ac{CLI} by utilizing commands such as \inlineBash{astrocast --help}. This section allows for the utilization of a predefined configuration file to streamline the process. Additionally, an 'Argument Explorer' is integrated to facilitate quick testing of various parameters and seamless export of the configuration file. If users want to follow this protocol along, we prepared a jupyter notebook for convenience.

During the Encoding (b) and Analysis (c) block, the approach varies based on the specificities of the experiment at hand, be it comparing drug treatments, model systems, correlating with stimuli, or analyzing changes over time. This segment of the pipeline now implements a separate GUI, offering a dynamic platform for detailed analysis and data visualization.
